# In YAML (used by GitHub Actions), indentation must be consistent, and each level uses 2 spaces (not tabs).
name: Node.js CI (Npm)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x] # You can add more versions if needed

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # - name: Install dependencies
      #   run: npm install --frozen-lockfile  # why: --frozen-lockfile ensures lock file is not modified., If the lock file is out-of-sync with package.json, it will fail.

      - name: Install dependencies
        run: npm ci  #ci = clean install: deletes node_modules and installs exactly what is in package-lock.json., Faster than npm install for CI., Fails if lock file is out-of-sync (this is good for CI, because you don’t want mismatched dependencies).
# # 3️⃣ Why remove npm install --frozen-lockfile in CI
# Both commands are doing the same thing in CI (install dependencies from package-lock.json).
# Having both is redundant — it runs two installs unnecessarily, wasting time.
# npm ci is preferred for CI/CD because it’s faster and deterministic.
      - name: Lint code
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Run coverage
        run: npm run coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  deploy: # ✅ Correct: deploy is under jobs, same level as build-and-test
      needs: build-and-test
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/main' # deploy only on main branch

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: 20

        - name: Install dependencies
          run: npm ci

        - name: Deploy to Vercel
          env:
            VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          run: |
            npx vercel deploy \
              --prod \
              --token $VERCEL_TOKEN \
              --confirm